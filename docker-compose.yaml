version: "3.8"

services:
  app:
    image: johannesjo/super-productivity:latest
    restart: unless-stopped
    expose:
      - "80"
    environment:
      WEBDAV_BASE_URL: ${WEBDAV_BASE_URL:?}
      WEBDAV_USERNAME: ${WEBDAV_USERNAME:?}
      WEBDAV_SYNC_FOLDER_PATH: ${WEBDAV_SYNC_FOLDER_PATH:-/}
      SYNC_INTERVAL: ${SYNC_INTERVAL:-15}
      IS_COMPRESSION_ENABLED: ${IS_COMPRESSION_ENABLED:-true}
      IS_ENCRYPTION_ENABLED: ${IS_ENCRYPTION_ENABLED:-false}
    depends_on:
      - webdav
    labels:
      - "traefik.enable=true"

      # App router (protect everything EXCEPT /webdav)
      - "traefik.http.routers.sp-app-auth.rule=Host(`sp.merteraslan.com`) && PathPrefix(`/`) && !PathPrefix(`/webdav`)"
      - "traefik.http.routers.sp-app-auth.entryPoints=https"
      - "traefik.http.routers.sp-app-auth.tls=true"
      - "traefik.http.routers.sp-app-auth.tls.certresolver=letsencrypt"
      - "traefik.http.routers.sp-app-auth.priority=20000"
      - "traefik.http.routers.sp-app-auth.middlewares=gzip,sp-auth@file"
      - "traefik.http.routers.sp-app-auth.service=sp-app-svc"
      - "traefik.http.services.sp-app-svc.loadbalancer.server.port=80"

  webdav:
    image: hacdias/webdav:latest
    restart: unless-stopped
    expose:
      - "2345"
    environment:
      WEBDAV_USERNAME: ${WEBDAV_USERNAME:?}
      WEBDAV_PASSWORD: ${WEBDAV_PASSWORD:?}
    volumes:
      - ./webdav.yaml:/config.yml:ro
      - webdav_data:/data
    command: ["-c", "/config.yml"]

    # IMPORTANT: no healthcheck (otherwise Traefik may drop the container if it doesn't return 2xx)
    labels:
      - "traefik.enable=true"

      # Strip /webdav before forwarding to the WebDAV server
      - "traefik.http.middlewares.dav-strip.stripPrefix.prefixes=/webdav"

      # WebDAV router on the same host, different path
      - "traefik.http.routers.sp-webdav.rule=Host(`sp.merteraslan.com`) && PathPrefix(`/webdav`)"
      - "traefik.http.routers.sp-webdav.entryPoints=https"
      - "traefik.http.routers.sp-webdav.tls=true"
      - "traefik.http.routers.sp-webdav.tls.certresolver=letsencrypt"
      - "traefik.http.routers.sp-webdav.priority=21000"
      - "traefik.http.routers.sp-webdav.middlewares=gzip,dav-strip"
      - "traefik.http.routers.sp-webdav.service=sp-webdav-svc"
      - "traefik.http.services.sp-webdav-svc.loadbalancer.server.port=2345"

volumes:
  webdav_data:
