version: "3.8"

services:
  # Super Productivity app (frontend)
  app:
    image: johannesjo/super-productivity:latest
    restart: unless-stopped
    expose:
      - "80"
    environment:
      WEBDAV_BASE_URL: ${WEBDAV_BASE_URL:?}
      WEBDAV_USERNAME: ${WEBDAV_USERNAME:?}
      WEBDAV_SYNC_FOLDER_PATH: ${WEBDAV_SYNC_FOLDER_PATH:-/}
      SYNC_INTERVAL: ${SYNC_INTERVAL:-15}
      IS_COMPRESSION_ENABLED: ${IS_COMPRESSION_ENABLED:-true}
      IS_ENCRYPTION_ENABLED: ${IS_ENCRYPTION_ENABLED:-false}
    depends_on:
      - webdav
    labels:
      # Add basic auth middleware (store SP_BASIC_AUTH_USERS in Coolify as a SECRET env var)
      - "traefik.http.middlewares.sp-auth.basicauth.users=${SP_BASIC_AUTH_USERS:?}"

      # Attach it to the existing Coolify-generated router.
      # Keep gzip (Coolify already uses it), add sp-auth.
      - "traefik.http.routers.http-0-hkwck48kwk0gssws4ggog0o0-app.middlewares=gzip,sp-auth"

  # WebDAV sync server
  webdav:
    image: hacdias/webdav:latest
    restart: unless-stopped
    expose:
      - "2345"
    environment:
      WEBDAV_USERNAME: ${WEBDAV_USERNAME:?}
      WEBDAV_PASSWORD: ${WEBDAV_PASSWORD:?}
    volumes:
      - ./webdav.yaml:/config.yml:ro
      - webdav_data:/data
    command: ["-c", "/config.yml"]
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:2345/"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

volumes:
  webdav_data:
